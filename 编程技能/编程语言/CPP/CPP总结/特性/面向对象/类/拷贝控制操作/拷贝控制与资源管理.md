# 一. 简介

如果一个类要**管理类外资源**，那么通常必须定义拷贝控制成员。这种类需要通过析构函数来释放对象所分配的资源。而一旦一个类需要析构函数，那么它几乎肯定也需要一个拷贝构造函数和一个拷贝赋值运算符。

而在定义这些成员之前，我们首先必须确定此类型对象的拷贝语义。就像一个`string`类的拷贝操作是将一个`string`对象复制到另一个`string`对象，修改其中任意一个对象并不会影响另一个对象；以及一个`shared_ptr`类的拷贝操作是让新创建的对象和被拷贝的对象共享同一个控制块，修改其中任意一个对象会影响到另一个对象。这两种类型的拷贝分别被称作：**行为像值的类**和**行为像指针的类**。



# 二. 行为像值的类

一个行为像值的类它的拷贝控制操作都比较简单，它的拷贝构造函数完成对整个对象的拷贝，并且需要一个析构函数来释放对象空间，唯一需要注意的是拷贝赋值运算符，它一般是组合了析构函数和拷贝构造函数的操作。

对于赋值运算符的操作要求，需要记住两点：

- 如果将一个对象赋予它自身，赋值运算符必须能正确工作
- 大多数赋值运算符组合了析构函数和拷贝构造函数的工作

当编写一个赋值运算符时，一个好的模式是先将右侧运算对象拷贝到一个局部临时对象中（为了满足上面的第一点）。当拷贝完成后，销毁左侧运算对象的现有成员就是安全的了。一旦左侧运算对象的资源被销毁，就只剩下将数据从临时对象拷贝到左侧运算对象的成员中了。



# 三. 行为像指针的类

对于行为像指针的类，我们需要为其定义拷贝构造函数和拷贝赋值运算符，来拷贝指针成员本身而不是它指向的对象。

我们可以像`shared_ptr`一样对资源进行管理，即使用引用计数，引用计数的工作方式如下：

- 除了初始化对象外，每个构造函数（拷贝构造函数除外）还要创建一个引用计数，用来记录有多少对象与正在创建的对象共享状态。当我们创建一个对象时，只有一个对象共享状态，因此将计数器初始化为 1
- 拷贝构造函数不分配新的计数器，而是共享给定对象的数据成员，包括计数器。拷贝构造函数递增共享的计数器，指出给定对象的状态又被一个新用户所共享。
- 析构函数递减计数器，指出共享状态的用户少了一个。如果计数器变为 0，则析构函数释放状态。
- 拷贝赋值运算符递增右侧运算对象的计数器，递减左侧运算对象的计数器。如果左侧运算对象的计数器变为 0，意味着它的共享状态没有用户了，拷贝赋值运算符就必须销毁状态

这个引用计数通过动态内存分配，这样在创建一个对象时，我们也会分配一个新的计数器，而在拷贝和赋值一个对象时，我们只拷贝指向计数器的指针。这样就不必同时维护多个计数器了。