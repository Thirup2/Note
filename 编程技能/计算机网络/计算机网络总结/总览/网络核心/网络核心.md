# 一. 分组交换

整个因特网除了网络边缘之外就是网络核心了，主要是由互联因特网端系统的分组交换机和链路构成的网状网络。

在各种网络应用中，端系统彼此交换**报文**（message）。报文能够包含协议设计者需要的任何东西。报文可以执行一种控制功能，也可以包含数据，例如电子邮件系统、JPEG 图像或 MP3 音频文件。为了从源端向目的端系统发送一个报文，源将长报文划分为较小的数据块，称之为**分组**。

在源和目的地之间，每个分组都通过通信链路和**分组交换机**传送。交换机主要有两类：**路由器**和**链路层交换机**。分组以等于该链路最大传输速率的速度传输通过通信链路。因此，如果某源端系统或分组交换机经过一条链路发送一个 L 比特的分组，链路的传输速率为 R 比特/秒，则传输该分组的时间为 L/R 秒。

其具体过程如下图所示：

![image](https://user-images.githubusercontent.com/91216205/204978134-8715959b-5a41-4b44-916b-e06844b170f9.png)

## 1. 存储转发传输

多数分组交换机在链路的输入端使用**存储转发传输**（store-and-forward transmission）机制。

存储转发传输是指：在交换机能够开始向传输链路传输该分组的第一个比特之前，必须接收到整个分组，如下图所示：

![image](https://user-images.githubusercontent.com/91216205/204978601-948b648e-ed39-470a-9465-34fe773e790a.png)

上图是一个经过简化之后的网络，只有两个端系统和一个路由器组成，而实际的一台路由器通常有多条繁忙的链路，因为它的任务就是把一个入分组交换到一条出链路。在这个简单例子中，该路由器的任务就只是将分组从一条输入链路转移到另一条唯一的连接链路。

可以看到，路由器已经接收到了分组 1 的一部分，但是路由器并没有急着将数据转发出去，而是在等着分组 1 传输完成，所以路由器的工作是先缓存一个分组，然后再将分组转发。

从转发速率上来说，如果使用存储转发传输，那么将一个分组从一个端系统发送到另一个端系统就需要经过两段，假设发送的分组大小为 L 比特，传播速率为 R 比特/秒，然后忽略传播时延（即数据走过相当长度链路所花的时间），那么第一段从发送端系统到路由器需要经过 L/R 的时间，然后从路由器到接收端系统需要经过 L/R 的时间，总的来说就是 2L/R 的时间。

而如果不使用存储转发传输，那么将一个分组从一个端系统发送到另一个端系统就只算一段，因为路由器不会在中间进行阻挡，而时接收到一个比特就转发一个比特，此时需要的时间就是 L/R。

按照存储转发传输的机制进行计算，通过由 N 条速率均为 R 的链路组成的路径（忽略传播时延）传输一个分组，那么端到端的时延是：
$$
d_{端到端}=N{L\over R}
$$
而对于一般情况，即 P 个分组，通过 N 条速率为 R 的链路组成的路径，此时端到端的时延是：
$$
d_{端到端}=[N+(P-1)]{L\over R}
$$


## 2. 排队时延和分组丢失

每台分组交换机有多条链路与之相连。对于每条相连的链路，该分组交换机具有一个**输出缓存**（output buffer，也称为**输出队列**（output queue）），它用于存储路由器准备发往那条链路的分组。

如果到达的分组需要传输到某条链路，但发现该链路正忙于传输其他分组，该到达分组必须在输出缓存中等待。因此，除了存储转发时延之外，分组还要承受输出缓存的**排队时延**（queuing delay）。这些时延时有变化的，变化的程度取决于网络的拥塞程度。

另外，由于缓存空间的大小是有限的，一个到达的分组可能发现该缓存已被其他等待传输的分组完全充满了。在此情况下，将会出现**分组丢失（丢包）**（packet loss），到达的分组或已经排队的分组之一将被丢弃。



## 3. 转发表和路由选择协议

路由器通过**转发表**（forwarding table）来查询一个发送来的分组的目的地址，并将其映射成为输出链路。

对于因特网而言，每个端系统具有一个称为 IP 地址的地址，当源主机要向目的端系统发送一个分组时，源在该分组的首部包含了目的地的 IP 地址。当某分组到达一台路由器时，路由器检查该地址，并用这个目的地址搜索其转发表，以发现适当的出链路。路由器则将分组导向该出链路。

每一个路由器只检查分组的目的地址的一部分，因为路由器的工作原理是将一个分组不断发往下一个更接近的路由器，最终到达端系统，而在离发送端系统近的路由器中只有地址前面部分的链路映射，只有越到后面，地址与链路的映射才越来越精确，最终到达接收端系统。

而对于每台路由器中的转发表，并非通过人工对每台路由器逐台进行配置，而是通过一些特殊的**路由选择协议**（routing protocol），用于自动地设置这些转发表。例如，一个路由选择协议可以决定从每台路由器到每个目的地的最短路径，并使用这些最短路径结果来配置路由器中的转发表。



# 二. 电路交换

通过网络链路和交换机移动数据有两种基本方法：**电路交换**（circuit switching）和**分组交换**（packet switching）。

