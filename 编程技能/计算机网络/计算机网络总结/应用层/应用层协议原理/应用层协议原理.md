# 一. 简介

网络应用程序的核心是写出能够运行在不同的端系统和通过网络彼此通信的程序。

以 Web 应用程序为例，就需要两个互相通信的不同的程序：一个运行在用户主机上的浏览器程序；另一个运行在 Web 服务器主机上的 Web 服务器程序。

而如果是 P2P 文件共享系统，在参与文件共享的社区中的每台主机中都有一个程序。在这种情况下，在各台主机中的这些程序可能都是类似的或相同的。

因此，当研发新应用程序时，通常需要编写将在多台端系统上运行的软件。



# 二. 网络应用程序体系结构

应用程序体系结构和网络体系结构应该是两个概念，首先应该区分。**应用程序体系结构**（application architecture）由应用程序研发者设计，规定了如何在各种端系统上组织该应用程序。

现代网络应用程序中常用以下两种主流体系结构之一：

- **客户-服务器体系结构**（client-server architecture）：在这个体系结构中，有一个总是打开的主机称为服务器，它服务于来自许多其他称为客户的主机的请求。一个典型的例子是 Web 应用程序，其中总是打开的 Web 服务器服务于来自浏览器（运行在客户主机上）的请求。当 Web 服务器接收到来自某客户对某对象的请求时，它向该客户发送所请求的对象作为响应。

  **注意**：

  - 利用客户-服务器体系结构，客户相互之间不直接通信。例如，在 Web 应用中两个浏览器并不直接通信
  - 在客户-服务器体系结构中，服务器应该具有固定的、周知的地址，该地址称为 IP 地址
  - 根据客户的多少，会影响到服务器的选择，对于客户量巨大的应用，如 Google 等都有用配备大量主机的**数据中心**创建的强大的虚拟服务器。如 Google 就有分布于全世界的 30 ～ 50 个数据中心，这些数据中心共同处理搜索任务、YouTube、Gamil 和其他服务。一个数据中心能够有数十万台服务器，它们必须要供电和维护。此外，服务提供商还必须支付不断出现的互联和带宽费用，以发送和接收到达/来自数据中心的数据。

  **实例**：

  - Web 应用程序
  - FTP 应用程序
  - Telnet
  - 电子邮件

- **P2P 体系结构**（P2P architecture）：在这种体系结构中，对位于数据中心的专用服务器有最小的甚至没有依赖。应用程序在间断连接的主机之间使用直接通信，这些主机对被称为**对等方**。这些对等方并不为服务提供商所有，相反为用户控制的端系统所有。许多目前流行的、流量密集型的应用都是 P2P 体系结构。

  **注意**：

  - P2P 最主要的特性之一就是它们的**自扩展性**（self-scalability）。比如在一个 P2P 文件共享应用中，每增加一个对等方请求文件，都会增加工作负载，但每个对等方也通过向其他对等方分发文件为系统增加服务能力。所以它们通常不需要庞大的服务器基础设施和服务器带宽。
  - P2P 应用由于高度非集中式结构，面临安全性、性能和可靠性等挑战

  **实例**：

  - 文件共享应用（如 BitTorrent）
  - 对等方协助下载加速器（如 迅雷）
  - 因特网电话和视频会议（如 Skype）



# 三. 进程通信

在一台机器上，可能由多个进程运行，它们使用操作系统提供的进程间通信机制相互通信。

而在两个不同的端系统上的进程，通过跨越计算机网络交换**报文**而相互通信。

下面是进程的类型：

## 1. 客户和服务器进程

网络应用程序由成对的进程组成，这些进程通过网络相互发送报文。

在 客户-服务器体系结构 中，一个客户浏览器进程与一台服务器进程交换报文；在 P2P 体系结构 中，文件从一个对等方中的进程传输到另一个对等方中的进程。

我们将每一对进程其中之一标识为**客户**（client），而另一个进程标识为**服务器**（server）。对于 P2P 体系结构 而言，一般将下载文件的对等方标识为客户，上传文件的对等方标识为服务器。

二者的严格定义如下：

> 在一对进程之间的通信会话场景中，发起通信（即在该会话开始时发起与其他进程的联系）的进程被标识为**客户**，在会话开始时等待联系的进程是**服务器**。



## 2. 进程与计算机网络之间的接口

进程即网络应用程序，属于应用层，而它的下一层是运输层，所以进程和计算机网络之间的接口也就是应用层和运输层之间的接口，这个接口称为**套接字**（socket），也被称为应用程序和网络之间的 API.

应用程序开发者可以控制套接字在应用层端的一切，但是对该套接字的运输层端几乎没有控制权。应用程序开发者对于运输层的控制仅限于：

1. 选择运输层协议，一旦应用程序开发者选择了一个运输层协议，则应用程序就建立在由该协议提供的运输层服务之上。
2. 也许能够设定几个运输层参数，如最大缓存和最大报文段长度等



## 3. 进程寻址

大多数时候一台电脑在同一时刻不止一个进程在使用网络，我们可以通过网卡提供的 MAC 地址和网络服务提供商提供的 IP 地址来标识一个端系统，可进程还没有办法找到，如果不对进程进行标识，那么端系统接收到的数据就不知道应该交给哪一个进程。所以为了标识这个接受进程，需要定义两种信息：

1. 主机的地址： 主要由其 **IP地址**（IP address）标识
2. 在目的主机中指定接收进程的标识符：通过**端口号**（port number）标识

流行的应用已经分配好了特定的端口号，如：Web 服务器用端口号 80 来标识；邮件服务器进程（使用 SMTP 协议）用端口号 25 来标识。用于所有因特网标准协议的周知端口号的列表能够在: http://www.iana.org 处找到。



# 四. 可供应用程序使用的运输服务

包括因特网在内的很多网络提供了不止一种运输层协议。当开发一个应用时，必须选择一种可用的运输层协议。

一般通过研究这些可用的运输层协议所提供的服务，选择一个最能为你的应用需求提供恰当服务的协议。

以下是一些网络应用的要求：

| 应用                | 数据丢失 | 带宽                                                     | 时间敏感   |
| ------------------- | -------- | -------------------------------------------------------- | ---------- |
| 文件传输            | 不能丢失 | 弹性                                                     | 不         |
| 电子邮件            | 不能丢失 | 弹性                                                     | 不         |
| Web 文档            | 不能丢失 | 弹性（几 kbps）                                          | 不         |
| 因特网电话/视频会议 | 容忍丢失 | 音频（几 kbps ～ 1 Mbps）<br />视频（10 kbps ～ 5 Mbps） | 是，100 ms |
| 流式存储音频/视频   | 容忍丢失 | 同上                                                     | 是，几秒   |
| 交互式游戏          | 容忍丢失 | 几 kbps ～ 10 kbps                                       | 是，100 ms |
| 智能手机讯息        | 不能丢失 | 弹性                                                     | 是和不是   |

我们通常通过以下四个方面来衡量一个应用程序需要的是什么样的服务：

## 1. 可靠数据传输

由于分组在计算机网络中可能丢失，因此，如果一个协议能够确保由应用程序的一端发送的数据正确、完全地交付给该应用程序的另一端，那么就认为该协议提供了**可靠数据传输**（reliable data transfer）。

当一个运输协议提供这种服务时，发送进程只要将其数据传递进套接字，就可以完全相信该数据将能无差错地到达接收进程。

当一个运输层协议不提供可靠数据传输时，由发送进程发送的某些数据可能到达不了接收进程。这可能能被**容忍丢失的应用**（loss-tolerant application）所接受，多媒体应用就属于这类应用。



## 2. 吞吐量

有些运输层协议能够以某种特定的速率提供确保的可用吞吐量。使用这种服务，该应用程序能够请求 r 比特/秒的确保吞吐量，并且该运输协议能够确保可用吞吐量总是为至少 r 比特/秒。具有吞吐量要求的应用程序被称为**带宽敏感的应用**（bandwidth-sensitive application）。许多当前的多媒体应用是带宽敏感的。

而**弹性应用**（elastic application）能够根据当时可用的带宽或多或少地利用可供使用的吞吐量。电子邮件、文件传输以及 Web 传送都属于弹性应用。



## 3. 定时

运输层协议也能提供定时保证。这种保证是因特网电话、虚拟环境、电话会议和多方游戏等应用所需要的。

对于非实时的应用，对端到端的时延没有严格的约束



## 4. 安全性

运输协议能够为应用程序提供一种或多种安全性服务。



# 五. 因特网提供的运输服务

上述讨论了计算机网络能够提供的通用运输服务。而 TCP/IP 网络为应用程序提供了两个运输层协议，分别是：TCP 和 UDP。

当我们为因特网创建一个新的应用时，首先要做出的决定是，选择 TCP 还是 UDP。

以下分别介绍了这两种协议：

## 1. TCP 服务

TCP 服务模型包括：**面向连接服务**和**可靠数据传输服务**

- 面向连接的服务：在应用曾数据报文开始流动之前，TCP 让客户和服务器互相交换运输层控制信息。这个所谓的握手过程提醒客户和服务器，让它们为大量分组的到来做好准备。在握手阶段后，一个 **TCP 连接**（TCP connection）就在两个进程的套接字之间建立了。通过这条连接，连接双方的进程可以在此连接上同时进行报文收发。当应用程序结束报文发送时，必须拆除该连接。
- 可靠的数据传送服务：通信进程能够依靠 TCP，无差错、按适当顺序交付所有发送的数据。当应用程序的一端将字节流传进套接字时，它能够依靠 TCP 将相同字节流交付给接收方的套接字，而没有字节的丢失和冗余。

另外，TCP 协议还具有拥塞控制机制，这种服务不一定能为通信进程带来直接好处，但能为因特网带来整体好处。当发送方和接收方之间的网络出现拥塞时，TCP 的拥塞控制机制会抑制发送进程（客户或服务器）。TCP 拥塞控制也试图限制每个 TCP 连接，使它们达到公平共享网络带宽的目的。

对于安全性，无论 TCP 还是 UDP 都没有提供任何加密机制，要对数据进行加密可以使用**安全套接字层**（Secure Sockets Layer, SSL）。需要注意的是，SSL 并非 TCP 和 UDP 之外的第三种运输协议， 而是一种对 TCP 的加强，这种强化是在应用层上实现的。而且如果一个应用程序要使用 SSL 的服务，它需要在该应用程序的客户端和服务器端包括 SSL 代码。SSL 有它自己的套接字 API。当一个应用使用 SSL 时，发送进程向 SSL 套接字传递明文数据，在发送主机中的 SSL 则加密该数据并将加密的数据传递给 TCP 套接字，加密的数据经因特网传送到接收进程中的 TCP 套接字，该接受套接字将加密数据传递给 SSL，由其进行解密，最后 SSL 通过它的 SSL 套接字将明文数据传递给接收进程。



## 2. UDP 服务

UDP 是一种不提供不必要服务的轻量级运输协议，它仅提供最小服务。UDP 是无连接的，因此在两个进程通信前没有握手过程。UDP 协议提供一种不可靠数据传送服务，也就是说，当进程将一个报文发送进 UDP 套接字时，UDP 协议并不保证该报文将到达接收进程。不仅如此，到达接收进程的报文也可能是乱序到达的。

UDP 没有包括拥塞控制机制，所以 UDP 的发送端可以用它选定的任何速率向其下层（网络层）注入数据。



## 3. 因特网运输协议所不提供的服务

在 TCP 和 UDP 服务中，并没有对吞吐量和定时保证的服务，这些服务目前的因特网运输协议并没有提供。但是即使没有这些服务，需要这些服务的应用仍然能够运行在当前的因特网上，这主要是归功于几种设计技巧。

一些应用使用的运输协议如下表所示：

| 应用         | 应用层协议                   | 支撑的运输协议 |
| ------------ | ---------------------------- | -------------- |
| 电子邮件     | SMTP                         | TCP            |
| 远程终端访问 | Telnet                       | TCP            |
| Web          | HTTP                         | TCP            |
| 文件传输     | FTP                          | TCP            |
| 流式多媒体   | HTTP                         | TCP            |
| 因特网电话   | SIR、RTP或专用的（如 Skype） | UDP 或 TCP     |



# 六. 应用层协议

当我们选择好了传输层的协议，就该构建应用本身了。我们通过**应用层协议**（application-layer protocol）来构建应用。

应用层协议定义了运行在不同端系统上的应用程序进程如何相互传递报文，特别是定义了：

- 交换的报文类型，例如请求报文和响应报文
- 各种报文类型的语法，如报文中的各个字段及这些字段是如何描述的
- 字段的语义，即这些字段中的信息的含义
- 确定一个进程何时以及如何发送报文，对报文进行相应的规则。

有些应用层协议是由 RFC 文档定义的，因此它们位于公共域中，例如，Web 的应用层协议 HTTP。还有很多别的应用层协议是专用的，有意不为公共域使用。

需要区分的是网络应用和应用层协议。应用层协议只是网络应用的一部分，如 Web 是一种客户-服务器应用，它允许客户按照需求从 Web 服务器获得文档。该 Web 应用有很多组成部分，包括：文档格式的标准（即 HTML）、Web 浏览器、Web 服务器，以及一个应用层协议。所以应用层协议只是网络应用中的一个部分。