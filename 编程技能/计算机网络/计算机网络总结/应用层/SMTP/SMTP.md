# 一. 简介

**SMTP** 是因特网电子邮件中主要的应用层协议，在介绍 SMTP 之前，首先对电子邮件进行一个了解。

因特网电子邮件系统的总体情况如下图所示：

![图片](https://user-images.githubusercontent.com/91216205/217468462-2dae4f3d-46c4-4858-87d8-44f90f5800b7.png)

从图中我们可以看到它有 3 个主要组成部分：**用户代理**（user agent）、**邮件服务器**（mail server）和**简单邮件传输协议**（Simple Mail Transfer Protocol, SMTP）

首先是用户代理，它允许用户阅读、回复、转发、保存和撰写报文。如微软的 Outlook 和 Apple Mail 都是电子邮件的用户代理，其作用是为用户提供方便快捷的邮件操作。另外，在用户代理中，相应的代理只处理该用户的邮箱信息，而不会把别人的邮箱交给非本人管理。

然后是邮件服务器，这从一个邮箱的域名就可以看出来，如 Outlook 邮箱就说明邮件存放在域名为 Outlook.com 的这个服务器中。在邮件服务器中，它管理所有用户的邮箱内容以及接收用户代理的操作，如发送邮件等等。

最后是简单邮件传输协议，当一个邮箱向另一个邮箱发送邮件时（特别是两个邮箱使用的邮件服务器不同时），两个邮件服务器就会通过这个协议传输邮件。

假设有一个使用 Outlook 邮件服务器的用户代理向一个使用 Apple Mail 邮件服务器的用户代理发送一个邮件，其过程如下：

- 首先在发送之前，在 Outlook 的用户代理上进行撰写邮件，然后设置好发送对象，点击发送即可。
- 用户代理接收到用户的发送请求，首先与其对应的邮件服务器建立连接，然后将写好的邮件发送到邮件服务器中
- 邮件服务器接收到邮件之后，分析要发送的目标，然后与目标服务器建立连接，将邮件发送到对方的邮件服务器中
- 对方的邮件服务器接收到邮件之后，分析要发送到的用户代理，然后将邮件分发到接收方的邮箱中
- 当对方要在他的邮箱中读取该报文时，包含他邮箱的邮件服务器（使用用户名和口令）来鉴别其身份

同时，发送方的邮箱也必须能处理接收方的邮件服务器的故障。如果发送方的服务器不能将邮件交付给接收方的服务器，发送方的邮件服务器在一个**报文队列**（message queue）中保持该报文并在以后尝试再次发送。通常每 30 分钟左右进行一次尝试；如果几天后仍不能成功，服务器就删除该报文并以电子邮件的形式通知发送方。

在了解了电子邮件之后，我们再来说明 SMTP。

SMTP 也有两部分：运行在发送方邮件服务器的客户端和运行在接收方邮件服务器的服务器端。每台邮件服务器上既运行 SMTP 的客户端，也运行 SMTP 的服务器端。当一个邮件服务器向其他邮件服务器发送邮件时，它就表现为 SMTP 的客户；当邮件服务器从其他邮件服务器上接收邮件时，它就表现为一个 SMTP 的服务器。

SMTP 有几个需要注意的地方：

- 它限制所有的邮件报文的体部分（不只是其首部）只能采用简单的 7 比特 ASCII 表示。如果要传输其他类型的数据，需要首先进行重新编码为 ASCII 数据，然后在接收方再进行还原。
- SMTP 一般不使用中间邮件服务器发送邮件，即使这两个邮件服务器位于地球的两端。
- SMTP 使用 TCP 进行可靠的数据传输服务，并且是持续连接方式。
- SMTP 默认端口号使用 25 号端口

# 二. 与 HTTP 的对比

**相同点**：

- 这两个协议都用于从一台主机向另一台主机传送文件：HTTP 从 Web 服务器向 Web 客户传送文件（对象）；SMTP 从一个邮件服务器向另一个邮件服务器传送文件（电子邮件报文）。
- 当进行文件传送时，持续的 HTTP 和 SMTP 都使用持续连接。

**区别**：

- HTTP 主要是一个**拉协议**（pull protocol）；而 SMTP 基本上是一个**推协议**（push protocol）
- SMTP 要求每个报文（包括它们的体）采用 7 比特 ASCII 码格式。HTTP 数据则不受这种限制
- 对于一个既包含文本又包含图形的文档，HTTP 把每个对象封装到它自己的 HTTP 响应报文中，而 SMTP 则把所有报文对象放在一个报文之中。



# 三. SMTP 报文

SMTP 的报文主要有两部分，一是包含环境信息的首部行，另一部分是报文体，这两个部分用空行进行分隔，如下面这个示例所示：

```smtp
From: alice@crepes.fr
To: bob@hamburger.edu
Subject: Searching for the meaning of life.

...
```

总结如下：

- `\br`：空格
- `\cr`：回车符
- `\lf`：换行符

```smtp
<首部行:>\br<值>\cr\lf
...
<首部行:>\br<值>\cr\lf
\cr\lf
(data data data ...)
```



# 四. 邮件访问协议

