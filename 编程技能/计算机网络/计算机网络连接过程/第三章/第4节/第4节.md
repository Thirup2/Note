### 一. 构成

* 端口模块
    * ADSL模块
    * FTTH模块
    * 通信线路
    * 无线局域网
    * 以太网模块
        * RJ-45接口
        * PHY(MAU)模块
        * MAC模块
        * 内存
* 包转发模块
    * 路由表
* **注: 路由器的各个端口都具有MAC地址和IP地址**



### 二. 路由表及路由表的维护

* 路由表

| 目标地址 | 子网掩码 | 网关 | 接口 | 跃点数 |
| :-: | :-: | :-: | :-: | :-: |
| 10.10.1.0 | 255.255.255.0 | \_\_\_\_ | e2 | 1 |
| 10.10.1.101 | 255.255.255.255 | \_\_\_\_ | e2 | 1 |
| 192.168.1.0 | 255.255.255.0 | \_\_\_\_ | e3 | 1 |
| 192.168.1.10 | 255.255.255.255 | \_\_\_\_ | e3 | 1 |
| 0.0.0.0 | 0.0.0.0 | 192.0.2.1 | e1 | 1 |

路由器将接受方IP地址与路由表中的目标地址进行比较, 并找到相应记录

* 转发过程
    1. 路由器会忽略主机号部分, 只匹配网络号部分, 过程通过子网掩码实现
    2. 网关和接口决定将网络包交给接口列中指定的网络接口, 并转发到网关列指定的IP地址
    3. 跃点数表示距离目的地的远近, 越大越远, 越小越近
* 路由表的维护
    1. 由人手动维护路由记录(不自动添加也不自动删除)
    2. 根据路由协议机制, 通过路由器之间的信息交换由路由器自行维护路由表的记录



### 三. 工作原理(以以太网端口为例)

1. 接收包
    1. 信号从网线接口到PHY(MAU)模块, 将光电信号转换为通用信号, 并传递给MAC模块
    2. MAC模块将通用信号转换为数字信息, 然后通过包末尾的FCS进行错误校验, 如果没问题则检查MAC头部中接收方MAC地址是否是自己, 全部检查完毕后放入接受缓冲区, 否则丢弃包
    3. 丢弃原有的MAC头部
2. 查询路由表确定输出端口
    1. 根据路由表判断转发目标
        1. 根据最长匹配原则筛选
        2. 选择跃点数较小的记录发送
    2. 路由器遇到不知道该转发到哪里的包时, 将直接丢弃, 并通过ICMP消息告知发送方
3. 发送前准备
    1. 找不到匹配路由时选择默认路由
        - 默认路由: 即目标地址与子网掩码全为0的列
        - 默认路由的IP地址为预设的网关地址
    2. 包的有效期
        * 路由器每次发送网络包时会更新IP头部中的TTL
        * TTL(Time to Live, 生存时间), 表示包的有效期, 一般初始值为64或128
        * 路由器每发送一次, 该值就减1
        * 当该值变为0时, 这个包就被丢弃
    3. 通过分片功能拆分大网络包
        * 首先通过输出端口的MTU判断这个包能不能不分片直接发送
        * 如果需要分片, 还需查询IP头部中的标志字段, 确认是否可以分片
        * 如果不能分片, 则丢弃这个包, 并通过ICMP消息通知发送方
        * 如果可以分片, 将按以下方法分片
            1. 将TCP头部及其后面的部分作为可分片数据
            2. 数据被拆分后, 每一份数据前面会加上IP头部
            3. IP头部中内容大部分未变, 部分记录分片相关信息的字段进行更新
    4. 发送
        - 按照输出端口类型的规则将包转换为电信号发送出去(以以太网规则为例)
            1. 通过ARP协议根据IP地址查询MAC地址, 并将查询结果作为接收方的MAC地址
            2. 将发送方MAC地址填写为输出端口的MAC地址
            3. 填写类型字段: 以太网类型0800(十六进制)
            4. 将MAC头部添加在包前面
            5. 发送