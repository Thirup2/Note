# 一. 简介

对于 C 语言来说，数组是一种很有用的数据类型，它可以将标量数据聚集成更大的数据类型。C 语言实现数组的方式非常简单，因此很容易翻译成机器代码。C 语言的一个不同寻常的特点是可以产生指向数组中元素的指针，并对这些指针进行运算。在机器代码中，这些指针会被翻译成地址计算。



# 二. 基本原则

对于数据类型 T 和整型常数 N，在 C 语言中的声明如下：

```c
T A[N];
```

起始位置表示为 $x_A$

该声明有两个效果，首先，它在内存中分配一个 $L\cdot N$ 个字节的连续区域，这里 $L$ 是数据类型 $T$ 的大小（单位为字节）。其次，它引入了标识符 $A$ ，可以用 $A$ 来作为指向数组开头的指针，这个指针的值就是 $x_A$。可以用 $0\sim N-1$ 的整数索引来访问该数组元素。数组元素 $i$ 会被存放在地址为 $x_A + L\cdot i$ 的地方。

一般通过比例变址寻址的方法来访问数组中的元素，假设有一个 4 字节数组 $E$，其起始位置 $x_E$ 中保存在`%rdx`寄存器中，需要访问的元素下标`i`保存在`%rcx`寄存器中，即：

```assembly
(%rdx,%rcx,4)
```

即可访问第`i+1`个数组元素，其执行的地址计算为：$x_E + 4i$，然后读取该位置的值。



# 三. 指针运算

C 语言中的指针指向内存中的一个地址，然后根据指针的类型决定应该从该地址取多少字节的数据作为该指针指向的值。也就是说，如果`p`是一个指向类型`T`的数据的指针，`p`的值为$x_p$，那么表达式`p+i`的值为$x_p+L\cdot i$，这里 $L$ 是数据类型`T`的大小。

另外，单操作数操作符`&`和`*`可以产生指针和简介引用指针，以及可以对数组和指针都应用数组下标操作。

总结操作如下：

假设一个整型数组`E`的起始位置和整数索引`i`分别存放在寄存器`%rdx`和`%rcx`中，下面的 C 语言表达式的汇编代码实现如下，结果存放在寄存器`%eax`（如果是数据）或寄存器`%rax`（如果是指针）中。

| C 语言表达式 | 类型   | 值             | 汇编代码                    |
| ------------ | ------ | -------------- | --------------------------- |
| `E`          | `int*` | $x_E$          | `movq %rdx,%rax`            |
| `E[0]`       | `int`  | $M[x_E]$       | `movl (%rdx),%eax`          |
| `E[i]`       | `int`  | $M[x_E+4i]$    | `movl (%rdx,%rcx,4),%eax`   |
| `&E[2]`      | `int*` | $x_E+8$        | `leaq 8(%rdx),%rax`         |
| `E+i-1`      | `int*` | $x_E+4i-4$     | `leaq -4(%rdx,%rcx,4),%rax` |
| `*(E+i-3)`   | `int`  | $M[x_E+4i-12]$ | `movl -4(%rdx,%rcx,4),%eax` |
| `&E[i]-E`    | `long` | $i$            | `movq %rcx,%rax`            |



# 四. 嵌套数组

还有一种特殊的数组，即数组元素为数组的数组，如`int A[5][3];`

实际上这个问题比较好解决，首先定义一个类型，该类型是一个包含 3 个`int`类型的数组，即`int n[3]`，它的大小应该是 12 个字节。然后划分一块 $5\times 12=60$个字节的区域，这就是数组`A`的大小。

对于这种嵌套数组的操作对应的汇编代码如下：

- `C`：一个外层数组元素包含的元素个数，此处是 3
- `L`：一个底层元素的类型大小，这里是 4 字节
- $x_A$：数组`A`的地址，假设存放在`%rdi`
- $i$：假设存放在`%rsi`
- $j$：假设存放在`%rdx`

| C 语言表达式 | 值                     | 汇编代码                                                     |
| ------------ | ---------------------- | ------------------------------------------------------------ |
| `A[i][j]`    | $M[x_D+L(C\cdot i+j)]$ | `leaq (%rsi,%rsi,C-1),%rax`<br />`leaq (%rdi,%rax,L),%rax`<br />`(%rax,%rdx,L)` |

