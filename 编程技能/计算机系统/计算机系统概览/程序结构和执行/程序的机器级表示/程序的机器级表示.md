主要基于x86-64介绍汇编语言。

能看懂汇编语言对于一个程序员来说是很重要的技能，首先大部分使用高级语言编写的程序都会先编译成汇编程序，然后才是可执行程序。由于汇编语言是基于指令集的编程语言，所以根据一个程序产生的汇编代码，我们可以找到很多可以优化的地方。

总的来说，汇编语言就是一个程序执行的细节，我们花时间去研究这些细节，就可以从一些细微的方面来提升程序的速度以及安全性。

由于汇编语言是基于机器的语言，所以我们首先需要来了解一下机器的一些概念。

我们区分两台机器相同还是不同，并非看它的生产厂商和型号，而是看它使用什么指令集，这一般是由CPU决定的。指令集也叫做机器的体系结构，比较常见的有：x86-64（x64）、x86、ARM等，它们的分类有两类，一类是复杂指令集（CISC），一类是精简指令集（RISC）。



下面是对x86-64的汇编语言的简单预览：

## 1. 操作数

### 1）寄存器

- 程序计数器（PC）：`%rip`

- 通用目的寄存器：

  ![image](https://user-images.githubusercontent.com/91216205/202988480-eed63842-c49e-467f-80af-00f0c9acb1f1.png)
  
- 条件码寄存器：

  - `CF`：进位标志。最近的操作使最高位产生了进位。可用来检查无符号操作的溢出。
  - `ZF`：零标志。最近的操作得出的结果为0.
  - `SF`：符号标志。最近的操作得到的结果为负数。
  - `OF`：溢出标志。最近的操作导致一个补码溢出——正溢出或负溢出。




### 2）立即数

**表示方法**：`$Imm`

**值**：`Imm`



### 3）存储器

- `M[Imm]`表示地址为`Imm`处的内存所保存的值
- `R[r]`表示寄存器`r`所保存的值
- `s`表示立即数的值

| 类型   | 表示方法         | 值                            | 名称                |
| ------ | ---------------- | ----------------------------- | ------------------- |
| 存储器 | $Imm$            | $M[Imm]$                      | 绝对寻址            |
| 存储器 | $(r_a)$          | $M[R[r_a]]$                   | 间接寻址            |
| 存储器 | $Imm(r_b)$       | $M[Imm+R[r_b]]$               | （基址+偏移量）寻址 |
| 存储器 | $(r_b, r_i)$     | $M[R[r_b]+R[r_i]]$            | 变址寻址            |
| 存储器 | $Imm(r_b,r_i)$   | $M[Imm+R[r_b]+R[r_i]]$        | 变址寻址            |
| 存储器 | $(,r_i,s)$       | $M[R[r_i]\cdot s]$            | 比例变址寻址        |
| 存储器 | $Imm(,r_i,s)$    | $M[Imm+R[r_i]\cdot s]$        | 比例变址寻址        |
| 存储器 | $(r_b,r_i,s)$    | $M[R[r_b]+R[r_i]\cdot s]$     | 比例变址寻址        |
| 存储器 | $Imm(r_b,r_i,s)$ | $M[Imm+R[r_b]+R[r_i]\cdot s]$ | 比例变址寻址        |



## 2. 操作

### 1）数据传送

| 指令                                                         | 效果                | 描述                                                         |
| :----------------------------------------------------------- | :------------------ | ------------------------------------------------------------ |
| $MOV \ S\ , \ D$                                             | $D\longleftarrow S$ | 传送                                                         |
| `movb`   $I\ ,\ R$<br />`movw`   $I\ ,\ R$<br />`movl`   $I\ ,\ R$<br />`movq`   $I\ ,\ R$<br />`movabsq`   $I\ ,\ R$ | $R\longleftarrow I$ | 传送字节<br />传送字<br />传送双字<br />传送四字<br />传送绝对的四字 |



| 指令                                                         | 效果                          | 描述                                                         |
| ------------------------------------------------------------ | ----------------------------- | ------------------------------------------------------------ |
| $MOVZ \ \ S\ ,\ R$                                           | $R\longleftarrow$ 零扩展$(S)$ | 以零扩展进行传送                                             |
| `movzbw`   $S\ ,\ R$<br />`movzbl`   $S\ ,\ R$<br />`movzwl`   $S\ ,\ R$<br />`movzbq`   $S\ ,\ R$<br />`movzwq`   $S\ ,\ R$ | $R\longleftarrow$ 零扩展$(S)$ | 将做了零扩展的字节传送到字<br />将做了零扩展的字节传送到双字<br />将做了零扩展的字传送到双字<br />将做了零扩展的字节传送到四字<br />将做了零扩展的字传送到四字 |



| 指令                                                         | 效果                                    | 描述                                                         |
| ------------------------------------------------------------ | --------------------------------------- | ------------------------------------------------------------ |
| $MOVS\ \ \ S\ ,\ R$                                          | $R\longleftarrow$ 符号扩展$(S)$         | 传送符号扩展的字节                                           |
| `movsbw`   $S\ ,\ R$<br />`movsbl`   $S\ ,\ R$<br />`movswl`   $S\ ,\ R$<br />`movsbq`   $S\ ,\ R$<br />`movswq`   $S\ ,\ R$<br />`movslq`   $S\ ,\ R$ | $R\longleftarrow$ 符号扩展$(S)$         | 将做了符号扩展的字节传送到字<br />将做了符号扩展的字节传送到双字<br />将做了符号扩展的字传送到双字<br />将做了符号扩展的字节传送到四字<br />将做了符号扩展的字传送到四字<br />将做了符号扩展的双字传送到四字 |
| `cltq`                                                       | `%rax`$\longleftarrow$ 符号扩展(`%eax`) | 把`%eax`符号扩展到`%rax`                                     |



| 指令      | 效果                                                         | 描述         |
| --------- | ------------------------------------------------------------ | ------------ |
| `pushq S` | $R[$`%rsp`$]\longleftarrow R[$`%rsp`$]-8$；<br />$M[R[$`%rsp`$]]\longleftarrow S$ | 将四字压入栈 |
| `popq D`  | $D\longleftarrow M[R[$`%rsp`$]]$；<br />$R[$`%rsp`$]\longleftarrow R[$`%rsp`$]+8$ | 将四字弹出栈 |



### 2）算术和逻辑操作

| 指令                                                         | 效果                                                         | 描述                                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------------------------------- |
| `leaq S, D`                                                  | $D\longleftarrow \&S$                                        | 加载有效地址                                              |
| `INC D`<br/>`DEC D`<br/>`NEG D`<br/>`NOT D`                  | $D\longleftarrow D+1$<br />$D\longleftarrow D-1$<br />$D\longleftarrow -D$<br />$D\longleftarrow \sim D$ | 加1<br />减1<br />取负<br />取补                          |
| `ADD S, D`<br/>`SUB S, D`<br/>`IMUL S, D`<br/>`XOR S, D`<br/>`OR S, D`<br/>`AND S, D` | $D\longleftarrow D+S$<br />$D\longleftarrow D-S$<br />$D\longleftarrow D*S$<br />$D\longleftarrow D$ ^ $S$<br />$D\longleftarrow D\ \|\ S$<br />$D\longleftarrow D\ \&\ S$ | 加<br />减<br />乘<br />异或<br />或<br />与              |
| `SAL k, D`<br />`SHL k, D`<br />`SAR k, D`<br />`SHR k, D`   | $D\longleftarrow D<<k$<br />$D\longleftarrow D<<k$<br />$D\longleftarrow D>>_A k$<br />$D\longleftarrow D>>_L k$ | 左移<br />左移（等同于`SAL`）<br />算术右移<br />逻辑右移 |

> - 大写的操作表示指令类，这些指令类有各种带不同大小操作数的变种；小写的操作表示具体的某个指令



| 指令                    | 效果                                                         | 描述                           |
| ----------------------- | ------------------------------------------------------------ | ------------------------------ |
| `imulq S`<br />`mulq S` | $R[$`%rdx`$]: R[$`%rax`$]\longleftarrow S\times R[$`%rax`$]$<br />$R[$`%rdx`$]: R[$`%rax`$]\longleftarrow S\times R[$`%rax`$]$ | 有符号全乘法<br />无符号全乘法 |
| `cqto`                  | $R[$`%rdx`$]: R[$`%rax`$]\longleftarrow$ 符号扩展$(R[$`%rax`$])$ | 转换为八字                     |
| `idivq S`               | $R[$`%rdx`$]\longleftarrow R[$`%rdx`$]: R[$`%rax`$]\ mod\ S$<br />$R[$`%rax`$]\longleftarrow R[$`%rdx`$]: R[$`%rax`$]\div S$ | 有符号除法                     |
| `divq S`                | $R[$`%rdx`$]\longleftarrow R[$`%rdx`$]: R[$`%rax`$]\ mod\ S$<br />$R[$`%rax`$]\longleftarrow R[$`%rdx`$]: R[$`%rax`$]\div S$ | 无符号除法                     |
